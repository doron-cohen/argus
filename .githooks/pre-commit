#!/usr/bin/env bash
set -euo pipefail

# Format Go (iterate all Go modules and run go fmt ./... in each)
if command -v go >/dev/null 2>&1; then
  echo "[pre-commit] go fmt ..."
  while IFS= read -r -d '' gomod; do
    moddir="$(dirname "$gomod")"
    echo "  - formatting module: $moddir"
    (
      cd "$moddir" && go fmt ./...
    )
  done < <(find . -name go.mod -not -path "./frontend/*" -print0)
fi

# Format frontend with Prettier (using Bun if available)
if [ -d "frontend" ]; then
  echo "[pre-commit] frontend prettier (staged files) ..."
  STAGED_FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^frontend/' | sed 's#^frontend/##' | grep -E '\\.(ts|tsx|js|jsx|css|html|json|md)$' || true)
  if [ -n "$STAGED_FRONTEND_FILES" ]; then
    if command -v bun >/dev/null 2>&1; then
      (
        cd frontend && echo "$STAGED_FRONTEND_FILES" | xargs -r bunx prettier -w
      )
    elif command -v npx >/dev/null 2>&1; then
      (
        cd frontend && echo "$STAGED_FRONTEND_FILES" | xargs -r npx --yes prettier -w
      )
    fi
  fi
fi

# Re-stage files in case formatting changed them
git add -A

echo "[pre-commit] formatting complete"

